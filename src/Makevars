# src/Makevars

# --- 1. Define Fortran Source Files in Compilation Order ---
# Module files MUST be listed first to generate the .mod files required by other sources.
MODULE_SRCS = rprintf_mod.f90 00tweedie_params.f90 Integrands.f90 

# Find all other Fortran source files in the directory and filter out the modules
# to prevent compiling them twice.
OTHER_F_SRCS = $(filter-out $(MODULE_SRCS), $(wildcard *.f90))

# The full source list, with modules prioritized
SRCS = $(MODULE_SRCS) $(OTHER_F_SRCS)

# Define the object files based on the source list order (this sets the build order)
OBJECTS = $(SRCS:.f90=.o)
# Add the C wrapper
OBJECTS += Rprintf_wrapper.o


# --- 2. Standard R Compilation Variables ---
# Define FFLAGS and use the standard SHLIB_FFLAGS
FFLAGS = $(SHLIB_FFLAGS) -g -fcheck=all


# --- 3. Custom GNU Make Dependency Rules ---
# These rules ensure that dependent files (like GaussQuadratureq.o) wait for the
# module file (.mod) to be created before they compile.

.PHONY: all
all: $(SHLIB)

twcdf.o: IntegralCompute.o

# Rule to explicitly create the Integrands_mod.mod file
GaussQuadratureq.o: Integrands_mod.mod
Integrands_mod.mod: Integrands.f90
	$(FC) $(FFLAGS) -c $< -o $@

IntegralCompute.o: Integrands.o findImk.o findImkd.o findImkdd.o findRek.o findRekd.o acceleratenew.o GaussQuadratureq.o rtnewton.o rtsafe.o

LDFLAGS += -Wl,-rpath,$(R_HOME)/bin/exec/R/lib
