# src/Makevars
# Temporarily add these flags to FFLAGS for debugging
#FFLAGS += -fcheck=all -Wall -Wextra -g -O0

# --- 1. Define Fortran Source Files in Compilation Order ---
# Module files MUST be listed first to generate the .mod files required by other sources.
MODULE_SRCS = rprintf_mod.f90 00tweedie_params.f90 Calcs_Imag.f90 Calcs_Real.f90 Integrands.f90 Calcs_Solvers.f90

# Find all other Fortran source files in the directory and filter out the modules
# to prevent compiling them twice.
OTHER_F_SRCS = $(filter-out $(MODULE_SRCS), $(wildcard *.f90))

# The full source list, with modules prioritized
SRCS = $(MODULE_SRCS) $(OTHER_F_SRCS)

# Define the object files based on the source list order (this sets the build order)
OBJECTS = $(SRCS:.f90=.o)
# Add the C wrapper
OBJECTS += Rprintf_wrapper.o
# ADD THE MANDATORY INITIALIZATION OBJECT FILE HERE
OBJECTS += init.o

# --- 2. Standard R Compilation Variables ---
# Define FFLAGS and use the standard SHLIB_FFLAGS
#FFLAGS = $(SHLIB_FFLAGS) -g -fcheck=all 


# --- 3. Custom GNU Make Dependency Rules ---
# These rules ensure that dependent files (like GaussQuadratureq.o) wait for the
# module file (.mod) to be created before they compile.

.PHONY: all
all: $(SHLIB)

# Explicit rule to ensure init.c is compiled using standard R C flags
# This prevents pollution from FFLAGS/FCFLAGS and ensures visibility.
# Explicit rule to ensure init.c is compiled using standard R C flags 
# (SHLIB_CFLAGS and SHLIB_C_FLAGS includes the path to R.h)
init.o: init.c
	$(CC) $(SHLIB_CFLAGS) $(SHLIB_C_FLAGS) -c $< -o $@
	
twcomputation.o: ComputeTwIntegral.o

# Rule to explicitly create the Integrands_mod.mod file
GaussQuadratureq.o: Integrands_mod.mod gaussian_data_mod.mod
Integrands_mod.mod: Integrands.f90
	$(FC) $(FFLAGS) -c $< -o $@
gaussian_data_mod.mod: gaussianData.f90
	$(FC) $(FFLAGS) -c $< -o $@

ComputeTwIntegral.o: Integrands.o accelerate.o GaussQuadratureq.o gaussianData.o

LDFLAGS += -Wl,-rpath,$(R_HOME)/bin/exec/R/lib


FCFLAGS = -fno-underscoring



