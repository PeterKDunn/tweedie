# --- 3. Custom GNU Make Dependency Rules ---
# These rules force the compilation order for modules that are used by others.
# Note: R's build system typically handles the final linking step, but we must
# ensure modules are built and used in the correct order using these dependencies.

.PHONY: all
all: $(SHLIB)

# --- Module Compilation Rules ---
# These rules explicitly define how the module file (.mod) and object file (.o)
# are created, and on which other modules they depend.

# 0. Base Parameters Module (NEW RULE)
# This module must be built first as all other modules depend on it.
rprintf_mod.o rprintf_mod.mod: rprintf_mod.f90
	$(FC) $(FFLAGS) $(FCFLAGS) -fPIC -c $< -o rprintf_mod.o

00tweedie_params.o 00tweedie_params.mod: 00tweedie_params.f90
	$(FC) $(FFLAGS) $(FCFLAGS) -fPIC -c $< -o 00tweedie_params.o

# 1. Calcs_Real Module (Fixes the _evaluaterek_ error)
# Depends on 00tweedie_params.mod because Calcs_Real.f90 uses the tweedie_params_mod.
Calcs_Real.o Calcs_Real.mod: Calcs_Real.f90 00tweedie_params.mod
	$(FC) $(FFLAGS) $(FCFLAGS) -fPIC -c $< -o Calcs_Real.o

# Depends on 00tweedie_params.mod because Calcs_Real.f90 uses the tweedie_params_mod.
Calcs_Imag.o Calcs_Imag.mod: Calcs_Imag.f90 00tweedie_params.mod
	$(FC) $(FFLAGS) $(FCFLAGS) -fPIC -c $< -o Calcs_Imag.o

# Depends on 00tweedie_params.mod because Calcs_Real.f90 uses the tweedie_params_mod.
Calcs_Solvers.o Calcs_Solvers.mod: Calcs_Solvers.f90 00tweedie_params.mod
	$(FC) $(FFLAGS) $(FCFLAGS) -fPIC -c $< -o Calcs_Solvers.o

# Depends on 00tweedie_params.mod because Calcs_Real.f90 uses the tweedie_params_mod.
Calcs_K.o Calcs_K.mod: Calcs_K.f90 Calcs_Solvers.mod 00tweedie_params.mod
	$(FC) $(FFLAGS) $(FCFLAGS) -fPIC -c $< -o Calcs_K.o

# 2. Integrands Module (Uses Calcs_Real)
# This is both a compilation rule and a dependency rule.
Integrands.o Integrands_mod.mod: Integrands.f90 Calcs_Real.mod
	$(FC) $(FFLAGS) $(FCFLAGS) -fPIC -c $< -o Integrands.o

# 3. gaussianData Module
gaussianData.o gaussian_data_mod.mod: gaussianData.f90 00tweedie_params.mod rprintf_mod.mod
	$(FC) $(FFLAGS) $(FCFLAGS) -fPIC -c $< -o gaussianData.o

# --- Object Dependency Rules ---
# These rules ensure the correct order for object files that consume modules.

# 4. GaussQuadrature.o (Uses Integrands_mod and gaussian_data_mod)
GaussQuadrature.o: Integrands_mod.mod gaussian_data_mod.mod

# 5. TweedieIntegration.o (The main integration routine, depends on many compiled objects)
# It uses Calcs_Real.mod via its dependencies, so we only list the .o files here.
TweedieIntegration.o: Integrands.o accelerate.o GaussQuadrature.o gaussianData.o

# --- Final Linker Flags ---
# 1. Portable LDFLAGS: Replaces the GNU += with the portable R variable and syntax.
# LDFLAGS is used directly for linking libraries.
LDFLAGS = $(LDFLAGS) -Wl,-rpath,$(R_HOME)/lib

# 2. Portable CPPFLAGS: Correctly uses PKG_CPPFLAGS for includes, but avoids the OpenMP macro.
PKG_CPPFLAGS = -I$(R_INCLUDE_DIR)

# 3. Portable CXXFLAGS (for OpenMP and C++ headers): 
#    - Uses the C++ OpenMP macro (required by the R Extensions manual).
#    - Moves the system C++ include path into the CXX-specific flags.
PKG_CXXFLAGS = $(SHLIB_OPENMP_CXXFLAGS) -I$(SDK_PATH)/usr/include/c++/v1

# 4. OpenMP Libraries: Links the necessary OpenMP libraries.
PKG_LIBS = $(SHLIB_OPENMP_LIBS)


